<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: chatroom.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: chatroom.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// modules =================================================
const http = require("http");
const WebSocket = require("ws");
const EventEmitter = require('events');
const jwt = require('jsonwebtoken');
const keys = require("../config/keys");
const mongoose = require("mongoose");
const agenda = require("agenda");
// custom modules ==========================================
const User = require("../models/User");
const Chat = require("../models/Chat");
const Message = require("../models/Message");
// =========================================================
/**
 * SocketServer represents the configurations specific to favor for its websocket server.
 * @constructor
 * @param {string} db - database to log stuff into
 * @param {string} wss - server instance
 */
class SocketServer extends EventEmitter {
  
  constructor (db, wss) {
    super();
    // this.wss = new WebSocket.Server({ server });
    this.wss = wss;
    this.chatRooms = db.collection(
      "chatRooms"
    ); // getting the chatRooms collection. 
    
    // this lets us look up a socket by its id;
    this.sockets = Object.create(null);
    // this is a list of all the sockets used for sending messages to everyone
    this.socketList = [];
    // this is just a number that counts up to give sockets each their own number
    this.socketId = 0;
  
    var server = this;
    this.wss.on('connection', function(ws) {
      let id;
      ws.on('message', message => {
        // we're expecting JSON, but if it's not don't just throw an error.
        try {
          let msg = JSON.parse(message);
          if (msg.type=="authenticate"){
            try {
              if (!msg.payload.token) {
                throw("no token");
              }
              var token = msg.payload.token.replace(/^Bearer\s+/, "");
              const decoded = jwt.verify(token,keys.secretOrKey);
              console.log(decoded)
              id = msg.id;
              server.sockets[id] = ws;
              server.socketList.push(id);
              console.log(new Date() + " Connection accepted.");
              server.send(id, { type: 'hello', id: id });
            } catch (error){
              ws.send(JSON.stringify({type: 'error', error:'Sorry, bad authentication request. Denied! '}))
            }
          } else {
            console.log(msg);
            server.emit(msg.type, id, msg);
          }
        } catch (e) {
          console.warn('invalid message: ', message);
          console.error(e);
        }
      })

      ws.on('close', () => {
        if (id==null) { 
          return;
        }
        server.sockets[id] = null;
        // remove socket from the broadcast list
        let index = server.socketList.indexOf(id);
        if (id > -1) {
          server.socketList.splice(index, 1);
        }
        server.emit('bye', id);
      });

    });  
    
    
    this.on('ping', (sender, message) => {
      this.send(sender, { type: 'pong' });
    });

    this.on('hello', (sender, message) => {
      this.broadcast({ type: 'update', id: sender, hue: message.hue });
      if (message.oldId) {
        this.broadcast({ type: 'bye', id: message.oldId });
      }
    });

    this.on('msg', (sender, message) => {
      Chat.findOne({ id:message.id },function (err, chat_instance) {
        if (chat_instance) {
          var new_msg = new Message({
            text: message.text,
            time: message.time,
            chat: chat_instance
          });
          chat_instance.messages += new_msg;
        chat_instance.save()
         .catch(err => console.log(err));
          for (var i=0;i&lt;chat_instance.users.length;i++) {
            var userId = chat_instance.users[i].id
            if (this.socketList.includes(userId)) {
              server.send(userId,{type:'update'})
            }
          }
        }
        else {
          server.send(sender,{type:'error',msg:'no chat with that id'})
        }
      });
    });
    this.on('bye', (sender) => {
      this.broadcast({ type: 'bye', id: sender });
    });
  }
  
  broadcast(msg) {
    this.socketList.forEach(p => this.send(p, msg));
  }

  send(id, msg) {
    if (this.sockets[id]) {
      this.sockets[id].send(JSON.stringify(msg));
    } else {
      console.warn(`no socket with the id ${id}`);
    }
  }
  
  
}

module.exports = SocketServer;
    </code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SocketServer.html">SocketServer</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Sat Jun 12 2021 21:43:53 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
